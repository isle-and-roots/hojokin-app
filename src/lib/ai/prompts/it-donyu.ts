import type { BusinessProfile } from "@/types";
import { profileContext } from "./shared";

type ItDonyuId =
  | "it-donyu-001"
  | "it-donyu-002"
  | "it-donyu-003"
  | "it-donyu-004";

type PromptFn = (profile: BusinessProfile, context?: string) => string;

// ============================================================
// it-donyu-001: デジタル化基盤導入枠
// ============================================================
const prompts001: Record<string, PromptFn> = {
  business_overview: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（デジタル化基盤導入枠）の交付申請書における「事業概要」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 業種・従業員規模・取り扱う商品・サービスを具体的に記述する
2. 現在のIT活用状況（会計ソフト・受発注・決済・ECの利用有無）に触れる
3. インボイス制度や電子帳簿保存法への対応ニーズが高い業種であれば積極的に言及する
4. 審査員が「この事業者にデジタル化基盤ツールが必要だ」と感じる内容にする
5. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  current_issues: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（デジタル化基盤導入枠）の「現在の業務課題」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 手書き・FAX・Excel管理・紙伝票など、現在のアナログ業務の具体的な課題を記述する
2. 受発注・会計・決済・EC等のどの領域でデジタル化が必要かを明確にする
3. インボイス制度対応や電子帳簿保存法への対応が困難な現状を示す（業種に合わせて）
4. 課題の深刻さを伝える（月何時間の工数、ミスの発生頻度など）
5. 「このITツールがなければ業務が非効率」という必然性を示す
6. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  it_tool_plan: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（デジタル化基盤導入枠）の「導入するITツールと活用方法」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 導入予定のITツール名・機能概要を記述する（不明な場合は [要入力: 導入予定ツール名] と明示）
2. ツールの主要機能（会計・受発注・決済・ECのいずれか）と業務プロセスへの組み込み方を説明する
3. IT導入支援事業者が登録するITツールを活用することに触れる
4. 現在の業務課題がどのように解決されるかを対応関係で示す
5. 導入後の業務フローを簡潔に描写する
6. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  expected_outcome: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（デジタル化基盤導入枠）の「導入による期待効果」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 定量的な効果を示す（月次処理時間の削減時間数、経費削減額等）
2. 労働生産性向上率を示す枠組みを提示する（IT導入補助金の必須KPI）
3. インボイス制度・電子帳簿保存法への対応完了という定性的効果も含める
4. データ活用による経営判断の高度化など、将来的な波及効果にも触れる
5. 具体的な数値は [要入力: ○○] で明示し、架空の数値を断言しない
6. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,
};

// ============================================================
// it-donyu-002: 通常枠
// ============================================================
const prompts002: Record<string, PromptFn> = {
  business_overview: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（通常枠）の交付申請書における「事業概要」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 業種・従業員規模・主要事業を具体的に記述する
2. 現在のIT活用状況と今後のDX推進に向けた方向性に触れる
3. A類型（30〜150万）またはB類型（150〜450万）の規模感に合った事業規模を表現する
4. 審査員が「この事業者の生産性向上にITツールが有効だ」と感じる内容にする
5. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  current_issues: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（通常枠）の「現在の業務課題」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 生産性向上を妨げている業務上の課題を複数列挙する
2. 顧客管理・販売管理・在庫管理・業務効率化など幅広い観点で課題を示す
3. 人手不足・属人化・情報共有の遅れ等、中小企業共通の課題を織り込む
4. ITツール（ERP/CRM/SaaS等）による包括的解決の必然性を示す
5. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  it_tool_plan: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（通常枠）の「導入ITツールと活用計画」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 導入予定のITツール名・機能概要を記述する（不明な場合は [要入力: 導入予定ツール名（例：kintone、Salesforce、freee等）] と明示）
2. 単機能の改善でなく、業務フロー全体の改革シナリオとして描写する
3. 現在の業務課題と導入ツールの機能が対応していることを明示する
4. 導入後の業務プロセス変化を具体的に示す
5. IT導入支援事業者との連携体制にも触れる
6. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  productivity_target: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（通常枠）の「生産性向上目標」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. IT導入補助金の申請要件である労働生産性向上率の目標を示す枠組みを提示する
2. 計算式の説明を含める：「付加価値額（営業利益＋人件費＋減価償却費）÷ 従業員数」
3. 目標の記述パターン：「導入前の労働生産性 [要入力: ○○万円/人] → 導入後 [要入力: ○○万円/人]（+○%）を3年以内に達成」
4. 目標値の根拠（業務時間削減・売上増加の見込み）を簡潔に説明する
5. 架空の具体数値を断言せず、[要入力:] で明示する
6. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,
};

// ============================================================
// it-donyu-003: セキュリティ対策推進枠
// ============================================================
const prompts003: Record<string, PromptFn> = {
  business_overview: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（セキュリティ対策推進枠）の「事業概要」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 業種・従業員規模・主要事業を記述する
2. 事業で取り扱う情報資産（顧客情報・取引情報・個人情報）の種類と量を明示する
3. 現在のIT環境の状況（PCの台数、ネットワーク環境、既存セキュリティ対策）に触れる
4. 取引先や顧客からセキュリティ強化を求められている実態があれば記述する
5. 審査員が「この事業者にセキュリティ対策が必要だ」と感じる内容にする
6. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  security_issues: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（セキュリティ対策推進枠）の「セキュリティ課題」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 業種特有のサイバーリスクを具体的に記述する（ランサムウェア・フィッシング・不正アクセス等）
2. 現状の対策状況と不十分な点を明示する（「現状はウイルス対策ソフトのみ」等）
3. SECURITY ACTION宣言の内容（1段階または2段階）との整合性を持たせる
4. サプライチェーン上の取引先への影響リスクにも触れる
5. セキュリティインシデント発生時の事業継続リスクを示す
6. 300〜500字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  security_plan: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（セキュリティ対策推進枠）の「セキュリティ対策計画」セクションを作成してください。

## 事業者情報
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 導入予定のサービス名を記述する（不明な場合は [要入力: 導入予定のお助け隊サービス名] と明示）
2. セキュリティ対策を「検知」「対応」「報告」の3要素で構成する
3. サービス導入後の運用体制・監視フローを説明する
4. 従業員へのセキュリティ教育・啓発計画も含める
5. 導入前後の対策レベルの比較を示す
6. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,
};

// ============================================================
// it-donyu-004: 複数社連携IT導入枠
// ============================================================
const prompts004: Record<string, PromptFn> = {
  partnership_overview: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（複数社連携IT導入枠）の「連携体制概要」セクションを作成してください。

## 事業者情報（幹事社）
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 幹事社（本事業者）の役割と参加事業者の規模を示す（参加者数：[要入力: 参加事業者数（10者以上）]）
2. 連携する商業集積地またはグループの名称を記述する（[要入力: 商業集積地名・グループ名]）
3. 幹事社が担う統括業務（取りまとめ・IT導入支援事業者との連絡・報告義務）を明確にする
4. 参加事業者の業種構成と共通点を示す
5. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  regional_issues: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（複数社連携IT導入枠）の「地域の課題」セクションを作成してください。

## 事業者情報（幹事社）
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 個社の課題ではなく、商業集積地・地域全体の共通課題として論述する
2. 集客力の低下・情報発信の非効率・業務管理の属人化など、地域事業者共通の問題を示す
3. デジタル化の遅れが地域全体の競争力低下につながっていることを示す
4. 個社では解決できず、連携によるIT導入が必要である理由を説明する
5. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  it_tool_plan: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（複数社連携IT導入枠）の「IT導入計画」セクションを作成してください。

## 事業者情報（幹事社）
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 参加事業者が共同利用するITツールの仕様を記述する（[要入力: 連携して導入するITツール名・主要機能]）
2. 共通プラットフォーム（商業集積地ポータル・共通POSシステム・情報共有基盤等）のイメージを示す
3. 各事業者がどのように活用するかの具体的な利用シナリオを説明する
4. 導入スケジュール・段階的な展開計画に触れる（[要入力: 導入開始時期]）
5. IT導入支援事業者との役割分担を明確にする
6. 500〜800字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,

  expected_outcome: (profile, context) =>
    `あなたは中小企業診断士として、IT導入補助金（複数社連携IT導入枠）の「期待される効果」セクションを作成してください。

## 事業者情報（幹事社）
${profileContext(profile)}

${context ? `## 追加情報\n${context}\n` : ""}
## 作成ルール
1. 個社の効果と地域全体への波及効果を両方記述する
2. 地域全体への波及効果：商業集積地の集客増・売上向上・地域DX実現・住民利便性向上
3. 定量的な効果は [要入力: 目標数値] で明示し、架空の数値を断言しない
4. 中長期的な地域経済活性化への貢献も示す
5. 労働生産性向上率の目標値枠組みを個社・全体両面で提示する
6. 400〜600字程度で記述する

## 出力形式
セクション本文をそのまま出力してください（マークダウン書式は使用しない、プレーンテキスト）。
情報が不足している箇所は [要入力: ○○] と明示してください。`,
};

// ============================================================
// プロンプトマップとエクスポート関数
// ============================================================
const PROMPTS: Record<ItDonyuId, Record<string, PromptFn>> = {
  "it-donyu-001": prompts001,
  "it-donyu-002": prompts002,
  "it-donyu-003": prompts003,
  "it-donyu-004": prompts004,
};

export function getItDonyuPrompt(
  subsidyId: string,
  sectionKey: string,
  profile: BusinessProfile,
  additionalContext?: string
): string {
  const frame = PROMPTS[subsidyId as ItDonyuId];
  if (!frame) {
    throw new Error(`Unknown IT_DONYU frame: ${subsidyId}`);
  }
  const fn = frame[sectionKey];
  if (!fn) {
    throw new Error(`Unknown section "${sectionKey}" for ${subsidyId}`);
  }
  return fn(profile, additionalContext);
}
